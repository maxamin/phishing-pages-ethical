define(["jquery","backbone","BaseView","nougat","fso-helper","buttonToggle"],function(e,t,n,r,i){"use strict";return n.extend({el:"body",currentView:null,events:{"focus .oem .textInput input":"applyClass","focusout .oem .textInput input":"removeClass","submit form.ajaxView":"proceed","click input[type=submit]":"formValidate","change .selectDropdown.hasError":"removeErrorClass","change .checkbox.hasError":"removeErrorClass","keyup .oem .textInput input[required]":"validateButtonRule","click .oem input[type=checkbox]":"validateButtonRule","change .oem .selectDropdown":"validateButtonRule","click #countryFlag":"openCountryList","click #goodieSeeTerms":"openGoodieSeeTerms"},initialize:function(){this.$("form").attr("novalidate","novalidate");var n=e(".textInput.hasError").get(0);n&&!(e(".oem").length>0)&&e(n).find(".error-submit").addClass("open"),e(".oem").length>0&&e(this).buttonToggle(),this.model=new t.Model},openCountryList:function(e){require(["widgets/overPanelView"],function(e){var t=new e;t.template="signup/flagPanel",t.render()})},openGoodieSeeTerms:function(e){require(["widgets/overPanelView"],function(e){var t=new e;t.template="activation/goodieSeeTerms",t.render()})},applyClass:function(t){e(t.target).parent().addClass("focus")},removeClass:function(t){e(t.target).parent().removeClass("focus")},activate:function(t){this.currentView&&(this.deactivate(this.currentView),t.delegateEvents(),t.$el.show(),t.render(),document.activeElement.blur());var n=e("body").data();n&&n.fsoToken!==""&&i.dropCookie(t,n.fsoToken),this.trackGA(),this.currentView=t},deactivate:function(e,t){if(!e)return;e.undelegateEvents(),t?e.remove():e.$el.hide()},removeErrorClass:function(t){e(t.target).closest("div").removeClass("hasError")},proceedSubmission:function(t){e(t.target).closest("form").submit(),e(t.target).attr("disabled",!0)},formValidate:function(t){t.preventDefault();var n=e(t.target).closest("form").find(":input[required]");n.each(function(){if(e(this).attr("type")==="checkbox"&&!e(this).is(":checked")){e(this).closest("div").addClass("hasError"),e(this).closest("div").find(".help-error").addClass("open");return}if(e(this).val()===""){e(this).closest("div").addClass("hasError error-empty");return}}),e(t.target).closest("form").find(".hasError").length||(e(t.target).attr("data-role")==="dialog"?e(this.currentView.el).trigger("loadDialog"):this.proceedSubmission(t))},proceed:function(t){var n=this.$(t.target),r=n.is("form")?"post":"get",i=n.attr("action")||n.attr("href"),s=n.is("form")?n.serialize()+"&_eventId_continue=Continue":[],o=this,u=e[r](i,s);t.preventDefault&&t.preventDefault(),this.validateForm(t)?u.done(function(e){o.model.set(e);if(e.data.redirect){document.location.href=e.data.redirect;return}e.data.isLoggedIn,o.template=e.viewName,o.render()}):n.find(".submitted :input")[0].focus()},trackGA:function(){if(e("#gaTrack").length){var t="Organic",n=e("#main").attr("class").trim();e.inArray(n,["oem","credit","pay-request","send-money"])!=-1&&(t="Intent_"+n),ga&&ga("send","event","Consumer Sign-Up",e("#gaTrack").data("track"),t)}},_doRender:function(t,n){n=n.replace("signup/",""),n=n.replace("wallet/","");var r=this.$("#"+n),i=e(t);r.length?(r.html(i.contents()),this.currentView.render()):(i.hide(),this.$el.append(i))},afterRender:function(){var e=this.template.replace("signup/","");e=e.replace("wallet/",""),this.$("form").attr("novalidate","novalidate"),t.history.navigate(e,{trigger:!0})},back:function(e){e.preventDefault(),window.history.go(-1)},validateButtonRule:function(t){var n=this.$(t.target);n.is("select")&&n.val()===""?n.closest("div").addClass("hasError"):"",e(this).buttonToggle()}})});